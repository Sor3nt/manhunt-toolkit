<?php
namespace App\Tests\LevelScripts;

use App\Bytecode\Helper;
use App\Service\Archive\Glg;
use App\Service\Archive\Mls;
use App\Service\Compiler\Compiler;
use Symfony\Bundle\FrameworkBundle\Test\KernelTestCase;

class TriggerScriptTest extends KernelTestCase
{

    public function test()
    {
//        $this->assertEquals(true, true, 'The bytecode is not correct');
//return;
        $script = "
scriptmain Triggerscript;

entity triggerWheelChair : et_name;


script OnEnterTrigger;
var
    pos, pos2, vel : vec3d;
    speed : real;

begin
	WriteDebug(GetEntityName(this), ' : OnEnterTrigger');

	EndScriptAudioStream;
	{PreLoadScriptAudioStream('WHEEL', false);
 	while not IsScriptAudioStreamPreLoaded do sleep(10);

	PlayScriptAudioStream(127);}

	

	SetVector(pos, -13.3461, 7.054, 2.25667);
	SetVector(vel, 0.838732, -0.0997477, -0.666577);
	speed := 10.0;
	vel.x := vel.x * speed;
	vel.y := vel.y * speed;
	vel.z := vel.z * speed;
	SpawnEntityWithVelocity('CJ_WHEELCHAIR1', pos, 'WheelChair', vel);
	{PlayScriptAudioStreamFromEntityAuto('WOM2', 100,GetEntity('WheelChair'),100);}
	
	RunScript('triggerWheelChair', 'RemoveStuffOne');
	
	RunScript('triggerWheelChair', 'RemoveStuffTwo');
	
	RemoveThisScript;
end;

script RemoveStuffOne;
begin
	
	{Close door, remove everything prior to this point}
	SetSlideDoorAjarDistance(GetEntity('asylum_cell_door_slide_gf_melee(SD)'), 1.1);
	SetDoorState(GetEntity('asylum_cell_door_slide_gf_melee(SD)'), DOOR_CLOSING);

	DestroyEntity(GetEntity('triggerStealthOneAware'));
	DestroyEntity(GetEntity('triggerStealthTwoAware'));
	DestroyEntity(GetEntity('triggerStealthThreeAware'));

	if NIL <> GetEntity('StealthTut(hunter)') then DestroyEntity(GetEntity('StealthTut(hunter)'));
	if NIL <> GetEntity('StealthTutTwo(hunter)') then DestroyEntity(GetEntity('StealthTutTwo(hunter)'));
	if NIL <> GetEntity('StealthTutThree(hunter)') then DestroyEntity(GetEntity('StealthTutThree(hunter)'));
	RemoveThisScript;
end;

script RemoveStuffTwo;
begin
	
{---------------------------------------
 Sector 2
 ---------------------------------------}

        DestroyEntity(GetEntity('mirror'));
        DestroyEntity(GetEntity('CJ_Radiator_old11'));
        DestroyEntity(GetEntity('CJ_Radiator_old13'));
        DestroyEntity(GetEntity('CJ_bunk_bed_upright04'));
        DestroyEntity(GetEntity('DE_MattressDown04'));
        DestroyEntity(GetEntity('CJ_bunk_bed_upright05'));
        DestroyEntity(GetEntity('DE_MattressDown05'));
        DestroyEntity(GetEntity('Wash_Bowl_Old04'));
        DestroyEntity(GetEntity('Wash_Bowl_Old05'));
        DestroyEntity(GetEntity('Wash_Bowl_Old06'));
        DestroyEntity(GetEntity('CJ_MINICAMB01'));
        DestroyEntity(GetEntity('DirtyOldToilet16'));
        DestroyEntity(GetEntity('DirtyOldToilet17'));
        DestroyEntity(GetEntity('SA_Rubbish_B'));
        DestroyEntity(GetEntity('SA_Rubbish_I'));
        DestroyEntity(GetEntity('SA_Rubbish_B02'));
        DestroyEntity(GetEntity('Clipboard_Medical05'));
        DestroyEntity(GetEntity('CJ_bunk_bed_upright11'));
        DestroyEntity(GetEntity('DE_MattressBent05'));
        DestroyEntity(GetEntity('SA_Rubbish_J02'));
        DestroyEntity(GetEntity('DirtyOldToilet18'));


{---------------------------------------
 Sector 3
 ---------------------------------------}

        DestroyEntity(GetEntity('CJ_Radiator_old10'));
        DestroyEntity(GetEntity('CJ_bunk_bed_upright06'));
        DestroyEntity(GetEntity('DE_MattressDown06'));
        DestroyEntity(GetEntity('Wash_Bowl_Old07'));
        DestroyEntity(GetEntity('CJ_MINICAMB02'));
        DestroyEntity(GetEntity('Gen_Tannoy_(F)05'));
        DestroyEntity(GetEntity('CJ_TROLLY08'));
        DestroyEntity(GetEntity('CJ_GREENHSHELVES06'));
        DestroyEntity(GetEntity('SA_Rubbish_F01'));
        DestroyEntity(GetEntity('Clipboard_Medical07'));
        DestroyEntity(GetEntity('SA_Rubbish_D02'));
        DestroyEntity(GetEntity('DirtyOldToilet19'));

end;
end.

        ";

        $expected = [


'10000000',
'0a000000',
'11000000',
'0a000000',
'09000000',
'34000000',
'09000000',
'28000000',
'12000000',
'01000000',
'49000000',
'10000000',
'01000000',
'86000000',
'73000000',
'21000000',
'04000000',
'01000000',
'00000000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'73000000',
'74000000',
'ce020000',
'22000000',
'04000000',
'01000000',
'0c000000',
'10000000',
'01000000',
'12000000',
'01000000',
'a0895541',
'10000000',
'01000000',
'4f000000',
'32000000',
'09000000',
'04000000',
'10000000',
'01000000',
'12000000',
'01000000',
'5ebae140',
'10000000',
'01000000',
'12000000',
'01000000',
'486d1040',
'10000000',
'01000000',
'84010000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'12000000',
'01000000',
'24b7563f',
'10000000',
'01000000',
'12000000',
'01000000',
'8648cc3d',
'10000000',
'01000000',
'4f000000',
'32000000',
'09000000',
'04000000',
'10000000',
'01000000',
'12000000',
'01000000',
'caa42a3f',
'10000000',
'01000000',
'4f000000',
'32000000',
'09000000',
'04000000',
'10000000',
'01000000',
'84010000',
'12000000',
'01000000',
'00002041',
'15000000',
'04000000',
'28000000',
'01000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'0f000000',
'02000000',
'18000000',
'01000000',
'04000000',
'02000000',
'10000000',
'01000000',
'13000000',
'01000000',
'04000000',
'28000000',
'10000000',
'01000000',
'52000000',
'0f000000',
'02000000',
'17000000',
'04000000',
'02000000',
'01000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'0f000000',
'01000000',
'32000000',
'01000000',
'04000000',
'10000000',
'01000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'0f000000',
'01000000',
'32000000',
'01000000',
'04000000',
'10000000',
'01000000',
'0f000000',
'02000000',
'18000000',
'01000000',
'04000000',
'02000000',
'10000000',
'01000000',
'13000000',
'01000000',
'04000000',
'28000000',
'10000000',
'01000000',
'52000000',
'0f000000',
'02000000',
'17000000',
'04000000',
'02000000',
'01000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'0f000000',
'01000000',
'32000000',
'01000000',
'08000000',
'10000000',
'01000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'0f000000',
'01000000',
'32000000',
'01000000',
'08000000',
'10000000',
'01000000',
'0f000000',
'02000000',
'18000000',
'01000000',
'04000000',
'02000000',
'10000000',
'01000000',
'13000000',
'01000000',
'04000000',
'28000000',
'10000000',
'01000000',
'52000000',
'0f000000',
'02000000',
'17000000',
'04000000',
'02000000',
'01000000',
'21000000',
'04000000',
'01000000',
'14000000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'22000000',
'04000000',
'01000000',
'0c000000',
'10000000',
'01000000',
'21000000',
'04000000',
'01000000',
'24000000',
'12000000',
'02000000',
'0b000000',
'10000000',
'01000000',
'10000000',
'02000000',
'22000000',
'04000000',
'01000000',
'24000000',
'10000000',
'01000000',
'a1020000',
'21000000',
'04000000',
'01000000',
'30000000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'21000000',
'04000000',
'01000000',
'44000000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'e4000000',
'21000000',
'04000000',
'01000000',
'30000000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'21000000',
'04000000',
'01000000',
'54000000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'e4000000',
'e8000000',
'11000000',
'09000000',
'0a000000',
'0f000000',
'0a000000',
'3b000000',
'00000000',
'10000000',
'0a000000',
'11000000',
'0a000000',
'09000000',
'21000000',
'04000000',
'01000000',
'64000000',
'12000000',
'02000000',
'24000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'12000000',
'01000000',
'cdcc8c3f',
'10000000',
'01000000',
'9b010000',
'21000000',
'04000000',
'01000000',
'64000000',
'12000000',
'02000000',
'24000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'12000000',
'01000000',
'03000000',
'10000000',
'01000000',
'97000000',
'21000000',
'04000000',
'01000000',
'8c000000',
'12000000',
'02000000',
'17000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'a4000000',
'12000000',
'02000000',
'17000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'bc000000',
'12000000',
'02000000',
'19000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'12000000',
'01000000',
'00000000',
'10000000',
'01000000',
'21000000',
'04000000',
'01000000',
'd8000000',
'12000000',
'02000000',
'13000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'0f000000',
'04000000',
'23000000',
'04000000',
'01000000',
'12000000',
'01000000',
'01000000',
'40000000',
'c8060000',
'33000000',
'01000000',
'01000000',
'24000000',
'01000000',
'00000000',
'3f000000',
'18070000',
'21000000',
'04000000',
'01000000',
'd8000000',
'12000000',
'02000000',
'13000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'12000000',
'01000000',
'00000000',
'10000000',
'01000000',
'21000000',
'04000000',
'01000000',
'ec000000',
'12000000',
'02000000',
'16000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'0f000000',
'04000000',
'23000000',
'04000000',
'01000000',
'12000000',
'01000000',
'01000000',
'40000000',
'90070000',
'33000000',
'01000000',
'01000000',
'24000000',
'01000000',
'00000000',
'3f000000',
'e0070000',
'21000000',
'04000000',
'01000000',
'ec000000',
'12000000',
'02000000',
'16000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'12000000',
'01000000',
'00000000',
'10000000',
'01000000',
'21000000',
'04000000',
'01000000',
'04010000',
'12000000',
'02000000',
'18000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'0f000000',
'04000000',
'23000000',
'04000000',
'01000000',
'12000000',
'01000000',
'01000000',
'40000000',
'58080000',
'33000000',
'01000000',
'01000000',
'24000000',
'01000000',
'00000000',
'3f000000',
'a8080000',
'21000000',
'04000000',
'01000000',
'04010000',
'12000000',
'02000000',
'18000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'e8000000',
'11000000',
'09000000',
'0a000000',
'0f000000',
'0a000000',
'3b000000',
'00000000',
'10000000',
'0a000000',
'11000000',
'0a000000',
'09000000',
'21000000',
'04000000',
'01000000',
'20010000',
'12000000',
'02000000',
'07000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'28010000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'3c010000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'50010000',
'12000000',
'02000000',
'16000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'68010000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'7c010000',
'12000000',
'02000000',
'16000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'94010000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'a8010000',
'12000000',
'02000000',
'10000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'bc010000',
'12000000',
'02000000',
'10000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'd0010000',
'12000000',
'02000000',
'10000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'e4010000',
'12000000',
'02000000',
'0e000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'f4010000',
'12000000',
'02000000',
'11000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'08020000',
'12000000',
'02000000',
'11000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'1c020000',
'12000000',
'02000000',
'0d000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'2c020000',
'12000000',
'02000000',
'0d000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'3c020000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'4c020000',
'12000000',
'02000000',
'14000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'64020000',
'12000000',
'02000000',
'16000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'7c020000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'90020000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'a0020000',
'12000000',
'02000000',
'11000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'b4020000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'c8020000',
'12000000',
'02000000',
'16000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'e0020000',
'12000000',
'02000000',
'12000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'f4020000',
'12000000',
'02000000',
'10000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'08030000',
'12000000',
'02000000',
'0e000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'18030000',
'12000000',
'02000000',
'11000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'2c030000',
'12000000',
'02000000',
'0c000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'3c030000',
'12000000',
'02000000',
'13000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'50030000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'60030000',
'12000000',
'02000000',
'14000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'78030000',
'12000000',
'02000000',
'0f000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'21000000',
'04000000',
'01000000',
'88030000',
'12000000',
'02000000',
'11000000',
'10000000',
'01000000',
'10000000',
'02000000',
'77000000',
'10000000',
'01000000',
'a0020000',
'11000000',
'09000000',
'0a000000',
'0f000000',
'0a000000',
'3b000000',
'00000000'
            
            
        ];


        $compiler = new Compiler();
        $levelScriptCompiled = $compiler->parse(file_get_contents(__DIR__ . '/0#levelscript.srce'));

        $compiler = new Compiler();
        $compiled = $compiler->parse($script, false);

        if ($compiled['CODE'] != $expected){
            foreach ($compiled['CODE'] as $index => $item) {
                if ($expected[$index] == $item){
                    echo ($index + 1) . '->' . $item . "\n";
                }else{
                    echo "MISSMATCH need " . $expected[$index] . " got " . $compiled['CODE'][$index] . "\n";
                }
            }
            exit;
        }

        $this->assertEquals($compiled['CODE'], $expected, 'The bytecode is not correct');
    }


}